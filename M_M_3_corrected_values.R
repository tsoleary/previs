# Take pinpoint isotopes plot and correct for synthesis and decay calc ---------

library(tidyverse)
library(plotly)

# Tidy the data ----------------------------------------------------------------

setwd("C:/Users/PrevBeast/Documents/R/Helms")

df_messy <- read.csv("All_isotopes_organized_select_reprex.csv")

samples <- colnames(df_messy)[4:length(colnames(df_messy))]

df_tidy <- df_messy %>% 
  gather(sample, abundance, samples) %>%
  separate("sample", c("group", "duplicate", "hrs"), sep = "_")

df_tidy$hrs <- as.numeric(df_tidy$hrs)

# average together the duplicate lines
df_avg <- df_tidy %>%
  group_by(protein, isotope, peptide, group, hrs) %>%
  summarize(abundance = mean(abundance))

# spreads out to columns by isotope: M_0, M_3, & Sum
df <- as.data.frame(spread(df_avg, "isotope", "abundance"))

# plot by protein, peptide, and isotope ----------------------------------------

pro <- as.character(unique(df$protein))

for (i in 1:length(pro)){
  
  temp <- filter(df, protein == pro[i])
  
  pep <- as.character(unique(temp$peptide))
  
  for (pep_x in pep){
  
    temp_pep <- filter(temp, peptide == pep_x)
    
    cols <- c(grep(c("M_0"), colnames(temp_pep)),
              grep(c("M_3"), colnames(temp_pep)),
              grep(c("Sum"), colnames(temp_pep)))
    
    for (j in cols){
     
      g1 <- ggplot(data = temp_pep) +
              geom_point(mapping = aes(x = hrs, 
                                       y = as.numeric(temp_pep[, colnames(temp_pep)[j]]), 
                                       color = Group), 
                         size = 3, alpha = 0.8) + 
              labs(title = paste(pro[i], pep_x, sep = " -- "), 
                   subtitle = colnames(temp_pep)[j],
                   y = "Abundance", x = "Time (hrs)") +
              theme_classic()
      plot(g1)
    }
  }
}

# figure out how to fit a one phase decay to the M-0 values -- probably need 
# to do the corrected M-0 values
# maybe figure out how to put all three M_0, M_3, and Sum in the same sort of 
# space
# plotly interactive too
# make the rest of it nice

# working on aesthetics
# ggplot(data = temp_pep) +
#   geom_point(mapping = aes(x = hrs,
#                            y = as.numeric(temp_pep[, colnames(temp_pep)[7]]),
#                            fill = sample, alpha = 0.5),
#              shape = 21, size = 3, stroke = 2, alpha = 0.9) +
#   labs(title = paste(pro[5], pep_x, sep = " -- "),
#        subtitle = colnames(temp_pep)[7],
#        y = "Abundance", x = "Time (hrs)") +
#   theme_classic()

# ggsave("test.pdf", dpi = 320) could save the specific files in a .pdf using
# the paste0() as the argument of the ggsave() in the for loop.


# Using plotly package ---------------------------------------------------------
# http://www.rebeccabarter.com/blog/2017-04-20-interactive/

# histone normalization of all isotopes ----------------------------------------

# average histones
df_hist <- df %>%
  group_by(protein, group, hrs) %>%
  summarize(avg_pro = mean(Sum)) %>%
  filter(protein == "Histones")

df <- cbind(df, hist_avg = df_hist$avg_pro)

# normailize all isotopes by histones 
isotopes <- c("M_0", "M_1", "M_2", "M_3", "M_4", "M_5", "M_6", "M_7", "Sum")

for (col in isotopes){
  df[, paste(col, "hist_norm", sep = "_")] <- df[, col] / df$hist_avg
}

# percent distribution of each isotope -----------------------------------------

# count number of leucines in a peptide
df$num_L <- str_count(df$peptide, pattern = "L")

# function to determine the distribution 
# p <- percent labeled leucine in media
# L <- number of leucines in peptide
# mass isotopomer (M_0 = 0, M_3 = 1, M_6 = 2, ...)
# (factorial(L)/(factorial(L-i)*factorial(i)))*(p^i)*(1-p)^(L-i)


# calculates the isotopic distribution of 
iso_dist <- function (pep, p = 0.5){
  
  L <- str_count(pep, pattern = "L")
  isos <- 0:L
  dis <- NULL

  for (i in isos){
    temp <- (factorial(L)/(factorial(L-i)*factorial(i)))*(p^i)*(1-p)^(L-i)
    dis <- c(dis, temp)
  }
  return(dis)
}

iso_dist("SAMPLLLLER")


# M_0, M_3, M_6 correction -----------------------------------------------------

# M_0 correction 

for (i in length(unique(hrs))){
  
}


# M_3 and M_6 correction


# Mega Model -------------------------------------------------------------------

# initial conditions
peptide <- "SAMPLLER"
num_L <- str_count(peptide, pattern = "L")
t0_abun <- 1000
per_lab <- 0.50

# rates
deg_old <- 0.0500
deg_new <- 0.0500


# data frame 
time <- 0:168

# nat_iso distribution
iso <- 0:8
m_z <- c(916.49, 917.49, 918.50, 919.50, 920.50, 921.50, 922.50, 923.50, 924.50)
per_total <- c(56.83, 28.41, 10.87, 3.05, 0.69, 0.13, 0.02, 0.00, 0.00)
per_max <- c(100.00, 49.99, 19.12, 5.36, 1.21, 0.23, 0.04, 0.01, 0.00)

nat_iso <- data.frame("isotope" = iso, "m/z" = m_z, "percent_total" = per_total,
                      "percent_max" = per_max)

# # web scraping? lets copy and paste first
# x_world <- c(802.3056,  803.2656,  803.2676, 803.2696, 803.2716, 803.2736, 803.2756, 803.2776, 803.2796, 803.2816, 803.2836, 803.2856, 803.2876, 803.2896, 803.2916, 803.2936, 803.2956, 803.2976, 803.2996, 803.3016, 803.3036, 803.3056, 803.3076, 803.3096, 803.3116, 803.3136, 803.3156, 803.3176, 803.3196, 803.3216, 803.3236, 803.3256, 803.3276, 803.3296, 803.3316, 803.3336, 803.3356, 803.3376, 803.3396, 803.3416, 803.3436, 803.3456, 803.3476, 803.3496, 803.3516, 803.3536, 803.3556, 803.3576, 803.3596, 803.3616, 803.3636, 803.3656, 803.3676, 803.3696, 803.3716, 803.3736, 803.3756, 803.3776, 803.3796, 803.3816, 803.3836, 803.3856, 803.3876, 803.3896, 803.3916, 803.3936, 803.3956, 803.3976, 803.3996, 803.4016, 803.4036, 803.4056, 803.4076, 803.4096, 803.4116, 803.4136, 803.4156, 803.4176, 803.4196, 803.4216, 803.4236, 803.4256, 803.4276, 803.4296, 803.4316, 803.4336, 803.4356, 803.4376, 803.4396, 803.4416, 803.4436, 803.4456, 803.4476, 803.4496, 803.4516, 803.4536, 803.4556, 803.4576, 803.4596, 803.4616, 803.4636, 803.4656, 803.4676, 803.4696, 803.4716, 803.4736, 803.4756, 803.4776, 803.4796, 803.4816, 803.4836, 803.4856, 803.4876, 803.4896, 803.4916, 803.4936, 803.4956, 803.4976, 803.4996, 803.5016, 803.5036, 803.5056, 803.5076, 803.5096, 803.5116, 803.5136, 803.5156, 803.5176, 803.5196, 803.5216, 803.5236, 803.5256, 803.5276, 803.5296, 803.5316, 803.5336, 803.5356, 803.5376, 803.5396, 803.5416, 803.5436, 803.5456, 803.5476, 803.5496, 804.2756, 804.2776, 804.2796, 804.2816, 804.2836, 804.2856, 804.2876, 804.2896, 804.2916, 804.2936, 804.2956, 804.2976, 804.2996, 804.3016, 804.3036, 804.3056, 804.3076, 804.3096, 804.3116, 804.3136, 804.3156, 804.3176, 804.3196, 804.3216, 804.3236, 804.3256, 804.3276, 804.3296, 804.3316, 804.3336, 804.3356, 804.3376, 804.3396, 804.3416, 804.3436, 804.3456, 804.3476, 804.3496, 804.3516, 804.3536, 804.3556, 804.3576, 804.3596, 804.3616, 804.3636, 804.3656, 804.3676, 804.3696, 804.3716, 804.3736, 804.3756, 804.3776, 804.3796, 804.3816, 804.3836, 804.3856, 804.3876, 804.3896, 804.3916, 804.3936, 804.3956, 804.3976, 804.3996, 804.4016, 804.4036, 804.4056, 804.4076, 804.4096, 804.4116, 804.4136, 804.4156, 804.4176, 804.4196, 804.4216, 804.4236, 804.4256, 804.4276, 804.4296, 804.4316, 804.4336, 804.4356, 804.4376, 804.4396, 804.4416, 804.4436, 804.4456, 804.4476, 804.4496, 804.4516, 804.4536, 804.4556, 804.4576, 804.4596, 804.4616, 804.4636, 804.4656, 804.4676, 804.4696, 804.4716, 804.4736, 804.4756, 804.4776, 804.4796, 804.4816, 804.4836, 804.4856, 804.4876, 804.4896, 804.4916, 804.4936, 804.4956, 804.4976, 804.4996, 804.5016, 804.5036, 804.5056, 804.5076, 804.5096, 804.5116, 804.5136, 804.5156, 804.5176, 804.5196, 804.5216, 804.5236, 804.5256, 804.5276, 804.5296, 804.5316, 804.5336, 804.5356, 804.5376, 804.5396, 804.5416, 804.5436, 804.5456, 805.2856, 805.2876, 805.2896, 805.2916, 805.2936, 805.2956, 805.2976, 805.2996, 805.3016, 805.3036, 805.3056, 805.3076, 805.3096, 805.3116, 805.3136, 805.3156, 805.3176, 805.3196, 805.3216, 805.3236, 805.3256, 805.3276, 805.3296, 805.3316, 805.3336, 805.3356, 805.3376, 805.3396, 805.3416, 805.3436, 805.3456, 805.3476, 805.3496, 805.3516, 805.3536, 805.3556, 805.3576, 805.3596, 805.3616, 805.3636, 805.3656, 805.3676, 805.3696, 805.3716, 805.3736, 805.3756, 805.3776, 805.3796, 805.3816, 805.3836, 805.3856, 805.3876, 805.3896, 805.3916, 805.3936, 805.3956, 805.3976, 805.3996, 805.4016, 805.4036, 805.4056, 805.4076, 805.4096, 805.4116, 805.4136, 805.4156, 805.4176, 805.4196, 805.4216, 805.4236, 805.4256, 805.4276, 805.4296, 805.4316, 805.4336, 805.4356, 805.4376, 805.4396, 805.4416, 805.4436, 805.4456, 805.4476, 805.4496, 805.4516, 805.4536, 805.4556, 805.4576, 805.4596, 805.4616, 805.4636, 805.4656, 805.4676, 805.4696, 805.4716, 805.4736, 805.4756, 805.4776, 805.4796, 805.4816, 805.4836, 805.4856, 805.4876, 805.4896, 805.4916, 805.4936, 805.4956, 805.4976, 805.4996, 805.5016, 805.5036, 805.5056, 805.5076, 805.5096, 805.5116, 805.5136, 805.5156, 805.5176, 805.5196, 805.5216, 805.5236, 805.5256, 805.5276, 805.5296, 805.5316, 805.5336, 805.5356, 806.2996, 806.3016, 806.3036, 806.3056, 806.3076, 806.3096, 806.3116, 806.3136, 806.3156, 806.3176, 806.3196, 806.3216, 806.3236, 806.3256, 806.3276, 806.3296, 806.3316, 806.3336, 806.3356, 806.3376, 806.3396, 806.3416, 806.3436, 806.3456, 806.3476, 806.3496, 806.3516, 806.3536, 806.3556, 806.3576, 806.3596, 806.3616, 806.3636, 806.3656, 806.3676, 806.3696, 806.3716, 806.3736, 806.3756, 806.3776, 806.3796, 806.3816, 806.3836, 806.3856, 806.3876, 806.3896, 806.3916, 806.3936, 806.3956, 806.3976, 806.3996, 806.4016, 806.4036, 806.4056, 806.4076, 806.4096, 806.4116, 806.4136, 806.4156, 806.4176, 806.4196, 806.4216, 806.4236, 806.4256, 806.4276, 806.4296, 806.4316, 806.4336, 806.4356, 806.4376, 806.4396, 806.4416, 806.4436, 806.4456, 806.4476, 806.4496, 806.4516, 806.4536, 806.4556, 806.4576, 806.4596, 806.4616, 806.4636, 806.4656, 806.4676, 806.4696, 806.4716, 806.4736, 806.4756, 806.4776, 806.4796, 806.4816, 806.4836, 806.4856, 806.4876, 806.4896, 806.4916, 806.4936, 806.4956, 806.4976, 806.4996, 806.5016, 806.5036, 806.5056, 806.5076, 806.5096, 806.5116, 806.5136, 806.5156, 806.5176, 806.5196, 806.5216, 806.5236, 807.3176, 807.3196, 807.3216, 807.3236, 807.3256, 807.3276, 807.3296, 807.3316, 807.3336, 807.3356, 807.3376, 807.3396, 807.3416, 807.3436, 807.3456, 807.3476, 807.3496, 807.3516, 807.3536, 807.3556, 807.3576, 807.3596, 807.3616, 807.3636, 807.3656, 807.3676, 807.3696, 807.3716, 807.3736, 807.3756, 807.3776, 807.3796, 807.3816, 807.3836, 807.3856, 807.3876, 807.3896, 807.3916, 807.3936, 807.3956, 807.3976, 807.3996, 807.4016, 807.4036, 807.4056, 807.4076, 807.4096, 807.4116, 807.4136, 807.4156, 807.4176, 807.4196, 807.4216, 807.4236, 807.4256, 807.4276, 807.4296, 807.4316, 807.4336, 807.4356, 807.4376, 807.4396, 807.4416, 807.4436, 807.4456, 807.4476, 807.4496, 807.4516, 807.4536, 807.4556, 807.4576, 807.4596, 807.4616, 807.4636, 807.4656, 807.4676, 807.4696, 807.4716, 807.4736, 807.4756, 807.4776, 807.4796, 807.4816, 807.4836, 807.4856, 807.4876, 807.4896, 807.4916, 807.4936, 807.4956, 807.4976, 807.4996, 807.5016, 807.5036, 807.5056, 807.5076, 808.3436, 808.3456, 808.3476, 808.3496, 808.3516, 808.3536, 808.3556, 808.3576, 808.3596, 808.3616, 808.3636, 808.3656, 808.3676, 808.3696, 808.3716, 808.3736, 808.3756, 808.3776, 808.3796, 808.3816, 808.3836, 808.3856, 808.3876, 808.3896, 808.3916, 808.3936, 808.3956, 808.3976, 808.3996, 808.4016, 808.4036, 808.4056, 808.4076, 808.4096, 808.4116, 808.4136, 808.4156, 808.4176, 808.4196, 808.4216, 808.4236, 808.4256, 808.4276, 808.4296, 808.4316, 808.4336, 808.4356, 808.4376, 808.4396, 808.4416, 808.4436, 808.4456, 808.4476, 808.4496, 808.4516, 808.4536, 808.4556, 808.4576, 808.4596, 808.4616, 808.4636, 808.4656, 808.4676, 808.4696, 808.4716, 808.4736, 808.4756, 808.4776, 808.4796, 808.4816, 808.4836, 809.3896, 809.3916, 809.3936, 809.3956, 809.3976, 809.3996, 809.4016, 809.4036, 809.4056, 809.4076, 809.4096, 809.4116, 809.4136, 809.4156, 809.4176, 809.4196, 809.4216, 809.4236, 809.4256, 809.4276, 809.4296, 809.4316, 809.4336, 809.4356, 809.4376, 809.4396, 809.4416)


# #WEB SCRAPING
# library("rvest")
# 
# #Specifying the url for desired website to be scraped
# url <- 'http://www.imdb.com/search/title?count=100&release_date=2016,2016&title_type=feature'
# 
# 
# #Reading the HTML code from the website
# webpage <- read_html(url)
# 
# rank_data_html <- html_nodes(webpage,'.text-primary')
# rank_data <- html_text(rank_data_html)


#Rdisop install (takes a long time)
# source("https://bioconductor.org/biocLite.R")
# biocLite("Rdisop")

library("Rdisop")

aa_form <- read.csv("aa_molecular_formula.csv")

L_row <- grep("L", aa_form$letter)

Leu <- as.character(aa_form[L_row, "molecular_formula"])

Leu2 <- getMolecule(Leu, z=1)

getIsotope(Leu, 1)
getIsotope(Leu2, seq(1,5))
















# Model data frame -------------------------------------------------------------
mod <- data.frame("time" = time)

